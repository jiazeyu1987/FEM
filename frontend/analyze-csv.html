<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CSV数据分析工具</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1, h2 {
            color: #333;
        }
        .upload-area {
            border: 2px dashed #ccc;
            padding: 20px;
            text-align: center;
            margin-bottom: 20px;
            border-radius: 5px;
        }
        .upload-area.dragover {
            background: #f0f8ff;
            border-color: #4CAF50;
        }
        .file-input {
            margin: 10px 0;
        }
        .results {
            margin-top: 20px;
        }
        .comparison-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }
        .group-box {
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 15px;
            background: #f9f9f9;
        }
        .group-box h3 {
            margin-top: 0;
            color: #555;
        }
        .stats-table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
        }
        .stats-table th,
        .stats-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: right;
        }
        .stats-table th {
            background: #f0f0f0;
            font-weight: bold;
        }
        .highlight {
            background: #fff3cd;
            font-weight: bold;
        }
        .significant-diff {
            color: #d32f2f;
            font-weight: bold;
        }
        .chart-container {
            width: 100%;
            height: 300px;
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .analysis-note {
            background: #e8f5e8;
            border: 1px solid #c3e6cb;
            border-radius: 5px;
            padding: 15px;
            margin: 20px 0;
        }
        .analysis-note h4 {
            margin-top: 0;
            color: #155724;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        .file-info {
            color: #666;
            font-size: 14px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>HEM分析结果CSV数据对比分析</h1>

        <div class="upload-area" id="uploadArea">
            <p>拖拽CSV文件到此处或点击选择文件</p>
            <input type="file" id="csvFile" accept=".csv" class="file-input">
        </div>

        <div class="file-info" id="fileInfo" style="display: none;">
            <span id="fileName"></span> |
            <span id="fileSize"></span> |
            <span id="rowCount"></span>
        </div>

        <div class="results" id="results" style="display: none;">
            <h2>数据对比分析结果</h2>

            <div class="comparison-grid">
                <div class="group-box">
                    <h3>前25行数据特征</h3>
                    <div id="top25Stats"></div>
                </div>

                <div class="group-box">
                    <h3>后25行数据特征</h3>
                    <div id="bottom25Stats"></div>
                </div>
            </div>

            <div class="group-box">
                <h3>主要差异对比</h3>
                <div id="comparisonStats"></div>
            </div>

            <div class="analysis-note" id="analysisConclusion">
                <h4>分析结论</h4>
                <div id="conclusionText"></div>
            </div>

            <div style="text-align: center; margin-top: 20px;">
                <button onclick="exportAnalysis()">导出分析报告</button>
                <button onclick="clearData()">清除数据</button>
            </div>
        </div>
    </div>

    <script>
        let csvData = [];
        let top25Data = [];
        let bottom25Data = [];

        // 文件上传处理
        const uploadArea = document.getElementById('uploadArea');
        const csvFile = document.getElementById('csvFile');

        uploadArea.addEventListener('click', () => csvFile.click());

        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        });

        csvFile.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFile(e.target.files[0]);
            }
        });

        function handleFile(file) {
            if (!file.name.endsWith('.csv')) {
                alert('请选择CSV文件');
                return;
            }

            document.getElementById('fileName').textContent = `文件名: ${file.name}`;
            document.getElementById('fileSize').textContent = `大小: ${(file.size / 1024).toFixed(1)} KB`;

            const reader = new FileReader();
            reader.onload = function(e) {
                parseCSV(e.target.result);
            };
            reader.readAsText(file, 'UTF-8');
        }

        function parseCSV(csvText) {
            const lines = csvText.trim().split('\n');
            if (lines.length < 1) {
                alert('CSV文件为空');
                return;
            }

            // 解析标题行
            const headers = lines[0].split(',').map(h => h.trim());

            // 解析数据行
            csvData = [];
            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(',').map(v => v.trim());
                if (values.length === headers.length) {
                    const row = {};
                    headers.forEach((header, index) => {
                        row[header] = values[index];
                    });
                    csvData.push(row);
                }
            }

            document.getElementById('rowCount').textContent = `总行数: ${csvData.length}`;

            if (csvData.length >= 50) {
                top25Data = csvData.slice(0, 25);
                bottom25Data = csvData.slice(-25);
                performAnalysis();
            } else {
                alert('CSV文件数据不足50行，无法进行前后25行对比');
            }
        }

        function performAnalysis() {
            document.getElementById('results').style.display = 'block';

            // 计算统计数据
            const top25Stats = calculateGroupStats(top25Data, '前25行');
            const bottom25Stats = calculateGroupStats(bottom25Data, '后25行');

            // 显示各组的统计数据
            document.getElementById('top25Stats').innerHTML = createStatsTable(top25Stats);
            document.getElementById('bottom25Stats').innerHTML = createStatsTable(bottom25Stats);

            // 生成对比分析
            const comparison = generateComparison(top25Stats, bottom25Stats);
            document.getElementById('comparisonStats').innerHTML = createComparisonTable(comparison);

            // 生成分析结论
            const conclusion = generateConclusion(comparison);
            document.getElementById('conclusionText').innerHTML = conclusion;
        }

        function calculateGroupStats(data, groupName) {
            const validData = data.filter(row => row['区间开始时间'] !== '无区间');

            const numericFields = [
                '蓝_平均值', '蓝_最大值', '蓝_最小值',
                '黄_平均值', '黄_最大值', '黄_最小值',
                '白_平均值', '白_最大值', '白_最小值',
                '粉_平均值', '粉_最大值', '粉_最小值',
                '紫_平均值', '紫_最大值', '紫_最小值'
            ];

            const stats = {
                groupName: groupName,
                totalRows: data.length,
                validIntervalRows: validData.length,
                noIntervalRows: data.length - validData.length,
                intervalStats: {},
                curveStats: {}
            };

            // 计算区间统计
            if (validData.length > 0) {
                const intervals = validData.map(row => ({
                    start: parseFloat(row['区间开始时间']),
                    end: parseFloat(row['区间结束时间']),
                    duration: parseFloat(row['区间结束时间']) - parseFloat(row['区间开始时间'])
                }));

                stats.intervalStats = {
                    avgStartTime: intervals.reduce((sum, i) => sum + i.start, 0) / intervals.length,
                    avgEndTime: intervals.reduce((sum, i) => sum + i.end, 0) / intervals.length,
                    avgDuration: intervals.reduce((sum, i) => sum + i.duration, 0) / intervals.length,
                    minDuration: Math.min(...intervals.map(i => i.duration)),
                    maxDuration: Math.max(...intervals.map(i => i.duration))
                };
            }

            // 计算各曲线统计
            numericFields.forEach(field => {
                const values = validData
                    .map(row => parseFloat(row[field]))
                    .filter(val => !isNaN(val));

                if (values.length > 0) {
                    stats.curveStats[field] = {
                        avg: values.reduce((sum, val) => sum + val, 0) / values.length,
                        min: Math.min(...values),
                        max: Math.max(...values),
                        std: Math.sqrt(values.reduce((sum, val) => sum + Math.pow(val - (values.reduce((s, v) => s + v, 0) / values.length), 2), 0) / values.length)
                    };
                }
            });

            return stats;
        }

        function createStatsTable(stats) {
            let html = `
                <table class="stats-table">
                    <tr><th>指标</th><th>数值</th></tr>
                    <tr><td>总行数</td><td>${stats.totalRows}</td></tr>
                    <tr><td>有效区间行数</td><td>${stats.validIntervalRows}</td></tr>
                    <tr><td>无区间行数</td><td>${stats.noIntervalRows}</td></tr>
            `;

            if (stats.intervalStats.avgStartTime !== undefined) {
                html += `
                    <tr><td>平均区间开始时间</td><td>${stats.intervalStats.avgStartTime.toFixed(2)}s</td></tr>
                    <tr><td>平均区间结束时间</td><td>${stats.intervalStats.avgEndTime.toFixed(2)}s</td></tr>
                    <tr><td>平均区间持续时间</td><td>${stats.intervalStats.avgDuration.toFixed(2)}s</td></tr>
                    <tr><td>最短区间持续时间</td><td>${stats.intervalStats.minDuration.toFixed(2)}s</td></tr>
                    <tr><td>最长区间持续时间</td><td>${stats.intervalStats.maxDuration.toFixed(2)}s</td></tr>
                `;
            }

            Object.entries(stats.curveStats).forEach(([field, fieldStats]) => {
                html += `
                    <tr>
                        <td>${field}</td>
                        <td>
                            均值:${fieldStats.avg.toFixed(2)} |
                            范围:[${fieldStats.min.toFixed(2)}, ${fieldStats.max.toFixed(2)}] |
                            标准差:${fieldStats.std.toFixed(2)}
                        </td>
                    </tr>
                `;
            });

            html += '</table>';
            return html;
        }

        function generateComparison(topStats, bottomStats) {
            const comparison = {
                intervalComparison: {},
                curveComparison: {}
            };

            // 比较区间统计
            if (topStats.intervalStats.avgStartTime !== undefined && bottomStats.intervalStats.avgStartTime !== undefined) {
                comparison.intervalComparison = {
                    avgDurationDiff: topStats.intervalStats.avgDuration - bottomStats.intervalStats.avgDuration,
                    validIntervalRatioDiff: (topStats.validIntervalRows / topStats.totalRows) - (bottomStats.validIntervalRows / bottomStats.totalRows)
                };
            }

            // 比较曲线统计
            Object.keys(topStats.curveStats).forEach(field => {
                if (bottomStats.curveStats[field]) {
                    const topMean = topStats.curveStats[field].avg;
                    const bottomMean = bottomStats.curveStats[field].avg;
                    const topStd = topStats.curveStats[field].std;
                    const bottomStd = bottomStats.curveStats[field].std;

                    comparison.curveComparison[field] = {
                        meanDiff: topMean - bottomMean,
                        meanDiffPercent: ((topMean - bottomMean) / Math.abs(bottomMean)) * 100,
                        stdDiff: topStd - bottomStd,
                        significance: Math.abs(topMean - bottomMean) > (topStd + bottomStd) / 2
                    };
                }
            });

            return comparison;
        }

        function createComparisonTable(comparison) {
            let html = `
                <table class="stats-table">
                    <tr><th>对比项</th><th>前25行 vs 后25行</th><th>差异显著性</th></tr>
            `;

            // 区间对比
            if (comparison.intervalComparison.avgDurationDiff !== undefined) {
                const durationSignificance = Math.abs(comparison.intervalComparison.avgDurationDiff) > 0.5;
                html += `
                    <tr class="${durationSignificance ? 'highlight' : ''}">
                        <td>平均区间持续时间差异</td>
                        <td>${comparison.intervalComparison.avgDurationDiff.toFixed(2)}s</td>
                        <td>${durationSignificance ? '显著差异' : '差异较小'}</td>
                    </tr>
                    <tr>
                        <td>有效区间比例差异</td>
                        <td>${(comparison.intervalComparison.validIntervalRatioDiff * 100).toFixed(1)}%</td>
                        <td>${Math.abs(comparison.intervalComparison.validIntervalRatioDiff) > 0.2 ? '显著差异' : '差异较小'}</td>
                    </tr>
                `;
            }

            // 曲线对比 - 只显示显著差异
            Object.entries(comparison.curveComparison).forEach(([field, comp]) => {
                if (comp.significance) {
                    html += `
                        <tr class="significant-diff">
                            <td>${field} 均值差异</td>
                            <td>${comp.meanDiff.toFixed(2)} (${comp.meanDiffPercent.toFixed(1)}%)</td>
                            <td>显著差异</td>
                        </tr>
                    `;
                }
            });

            // 如果没有显著差异
            if (html === `<table class="stats-table"><tr><th>对比项</th><th>前25行 vs 后25行</th><th>差异显著性</th></tr>`) {
                html += '<tr><td colspan="3" style="text-align:center;">未发现显著差异</td></tr>';
            }

            html += '</table>';
            return html;
        }

        function generateConclusion(comparison) {
            let conclusion = '';

            // 分析有效区间比例
            const topIntervalRatio = top25Data.filter(row => row['区间开始时间'] !== '无区间').length / top25Data.length;
            const bottomIntervalRatio = bottom25Data.filter(row => row['区间开始时间'] !== '无区间').length / bottom25Data.length;

            if (topIntervalRatio > 0.8 && bottomIntervalRatio < 0.2) {
                conclusion += '<strong>主要发现：前25行数据大部分有明确着色区间，后25行数据大部分没有着色区间。</strong><br>';
                conclusion += '这表明前25行可能对应着具有明显HEM事件的特征视频，而后25行可能对应正常或无明显变化的视频。<br><br>';
            } else if (Math.abs(topIntervalRatio - bottomIntervalRatio) > 0.3) {
                conclusion += `<strong>区间分布差异：前25行有效区间比例${(topIntervalRatio * 100).toFixed(0)}%，后25行有效区间比例${(bottomIntervalRatio * 100).toFixed(0)}%。</strong><br>`;
                conclusion += '这表明两组数据在HEM事件发生率上存在显著差异。<br><br>';
            }

            // 分析曲线差异
            const significantDiffs = Object.entries(comparison.curveComparison).filter(([field, comp]) => comp.significance);

            if (significantDiffs.length > 0) {
                conclusion += '<strong>曲线数值差异：</strong><br>';
                significantDiffs.forEach(([field, comp]) => {
                    const curveName = field.split('_')[0];
                    const direction = comp.meanDiff > 0 ? '更高' : '更低';
                    conclusion += `• ${curveName}曲线：前25行比后25行${direction}${Math.abs(comp.meanDiff).toFixed(2)} (${Math.abs(comp.meanDiffPercent).toFixed(1)}%)<br>`;
                });
                conclusion += '<br>';
            }

            // 综合结论
            if (significantDiffs.length > 2 || Math.abs(topIntervalRatio - bottomIntervalRatio) > 0.5) {
                conclusion += '<strong>综合分析结论：</strong>前25行和后25行数据在HEM事件特征上存在系统性差异，可能分别对应着不同的视频类型或生理状态。<br>';
            } else if (significantDiffs.length > 0) {
                conclusion += '<strong>综合分析结论：</strong>前25行和后25行数据在某些指标上存在差异，但整体特征较为相似。<br>';
            } else {
                conclusion += '<strong>综合分析结论：</strong>前25行和后25行数据在主要统计指标上没有显著差异，可能来自相似的视频群体。<br>';
            }

            return conclusion;
        }

        function exportAnalysis() {
            if (csvData.length === 0) {
                alert('请先加载数据');
                return;
            }

            const analysisResult = {
                fileInfo: {
                    fileName: document.getElementById('fileName').textContent,
                    totalRows: csvData.length,
                    analysisTime: new Date().toLocaleString()
                },
                top25Stats: calculateGroupStats(top25Data, '前25行'),
                bottom25Stats: calculateGroupStats(bottom25Data, '后25行'),
                comparison: generateComparison(
                    calculateGroupStats(top25Data, '前25行'),
                    calculateGroupStats(bottom25Data, '后25行')
                )
            };

            const blob = new Blob([JSON.stringify(analysisResult, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `HEM分析结果_${new Date().toISOString().slice(0, 10)}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function clearData() {
            csvData = [];
            top25Data = [];
            bottom25Data = [];
            document.getElementById('results').style.display = 'none';
            document.getElementById('csvFile').value = '';
        }
    </script>
</body>
</html>