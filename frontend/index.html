<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate, max-age=0" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>HEM Analyzer</title>
    <link rel="stylesheet" href="styles.css" />
  </head>
  <body>
    <div id="app">
      <header class="titlebar">
        <div class="title-left">
          <span class="dot red"></span>
          <span class="dot yellow"></span>
          <span class="dot green"></span>
        </div>
        <div class="title">HEM Analyzer</div>
        <div class="title-right">VS Code Theme</div>
      </header>

      <div class="container">
        <aside class="sidebar">
          <div class="section">
            <label class="label">视频文件 (mp4)</label>
            <input type="file" id="fileInput" accept="video/mp4" />
          </div>
          <div class="section">
            <label class="label">采样帧率 (fps)</label>
            <input type="number" id="sampleFps" min="1" max="30" step="1" value="8" />
          </div>
          <!-- Hidden default detection methods (all enabled by default) -->
<input type="checkbox" class="method" value="sudden" checked style="display:none" />
<input type="checkbox" class="method" value="threshold" checked style="display:none" />
<input type="checkbox" class="method" value="relative" checked style="display:none" />
          <!-- Hidden default parameters (keep functionality, remove UI) -->
<input type="number" id="p_smooth_k" min="1" max="21" step="1" value="3" style="display:none" />
<input type="number" id="p_baseline_n" min="3" max="200" step="1" value="10" style="display:none" />
<input type="number" id="p_sudden_k" min="0" step="0.5" value="6" style="display:none" />
<input type="number" id="p_sudden_min" min="0" step="0.5" value="4" style="display:none" />
<input type="number" id="p_threshold_delta" min="0" step="0.5" value="8" style="display:none" />
<input type="number" id="p_threshold_hold" min="1" max="30" step="1" value="1" style="display:none" />
<input type="number" id="p_relative_delta" min="0" step="0.5" value="6" style="display:none" />
        <div class="section">
            <button id="analyzeBtn" disabled>分析</button>
          </div>
          <div class="section">
            <label class="label">白色曲线波峰检测</label>
            <div class="detection-method-section">
              <label style="display: block; margin-bottom: 8px;">检测方法:</label>
              <div style="margin-bottom: 10px;">
                <label style="margin-right: 15px;">
                  <input type="radio" name="peakMethod" value="morphology" checked> 形态特征
                </label>
                <label>
                  <input type="radio" name="peakMethod" value="threshold"> 绝对阈值
                </label>
              </div>
            </div>

            <!-- 形态特征参数 -->
            <div class="morphology-params peak-controls">
              <label style="display: block; margin-bottom: 8px;">
                波峰高度阈值:
                <input type="number" id="peakSensitivity" min="10" max="200" step="5" value="20" style="width: 70px; margin-left: 8px;">
              </label>
              <label style="display: block; margin-bottom: 8px;">
                最小波峰宽度:
                <input type="number" id="minPeakWidth" min="2" max="10" step="1" value="3" style="width: 70px; margin-left: 8px;">
              </label>
              <label style="display: block; margin-bottom: 8px;">
                最大波峰宽度:
                <input type="number" id="maxPeakWidth" min="5" max="30" step="1" value="15" style="width: 70px; margin-left: 8px;">
              </label>
              <label style="display: block; margin-bottom: 8px;">
                波峰最小间距:
                <input type="number" id="peakMinDistance" min="1" max="20" step="1" value="5" style="width: 70px; margin-left: 8px;">
              </label>
            </div>

            <!-- 绝对阈值参数 -->
            <div class="threshold-params peak-controls" style="display: none; padding: 8px; background: #2a2a2a; border-radius: 4px; margin-top: 10px;">
              <label style="display: block; margin-bottom: 8px;">
                绝对阈值 (灰度值):
                <input type="number" id="absoluteThreshold" min="50" max="200" step="5" value="105" style="width: 70px; margin-left: 8px;">
              </label>
              <label style="display: block; margin-bottom: 8px;">
                基线帧数:
                <input type="number" id="baselineFrames" min="1" max="20" step="1" value="5" style="width: 70px; margin-left: 8px;">
              </label>
            </div>

            <div style="display: flex; gap: 8px; margin-top: 10px;">
              <button id="detectPeaksBtn" class="detect-btn" disabled>检测波峰</button>
              <button id="clearPeaksBtn" class="clear-btn-small" disabled>清除波峰</button>
            </div>
          </div>
          <!-- Hidden timeline shading parameters (keep functionality, remove UI) -->
<input type="number" id="p_rise_thresh" step="0.1" value="15.5" style="display:none" />
<input type="number" id="p_fall_thresh" step="0.1" value="-3" style="display:none" />
          <div class="section batch-section">
            <label class="label">批量分析</label>
            <div class="batch-controls">
              <div class="batch-file-section">
                <div class="drop-zone" id="dropZone">
                  <div class="drop-zone-content">
                    <p class="drop-zone-text">拖拽视频文件到此处</p>
                    <p class="drop-zone-text">或</p>
                    <input type="file" id="batchFileInput" multiple accept="video/mp4" style="display: none;">
                    <button type="button" id="batchLoadBtn" class="batch-btn secondary">批量加载</button>
                  </div>
                </div>
                <div class="batch-file-list" id="batchFileList" style="display: none;">
                  <div class="file-list-header">
                    <span>已选择文件 (<span id="fileCount">0</span>)</span>
                    <button type="button" id="clearFilesBtn" class="clear-btn-small">清空</button>
                  </div>
                  <div class="file-list-items" id="fileListItems"></div>
                </div>
              </div>
              <div class="batch-action-section">
                <button type="button" id="batchAnalyzeBtn" class="batch-btn primary" disabled>批量分析</button>
                <button type="button" id="batchDeepAnalyzeBtn" class="batch-btn primary" disabled>批量深度分析</button>
                <div class="batch-progress" id="batchProgress" style="display: none;">
                  <div class="progress-header">
                    <span>批量分析进度</span>
                    <span id="progressText">0%</span>
                  </div>
                  <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                  </div>
                  <div class="batch-status" id="batchStatus">准备就绪</div>
                </div>
                <div class="batch-progress" id="deepAnalysisProgress" style="display: none;">
                  <div class="progress-header">
                    <span>深度分析进度</span>
                    <span id="deepProgressText">0%</span>
                  </div>
                  <div class="progress-bar">
                    <div class="progress-fill" id="deepProgressFill"></div>
                  </div>
                  <div class="batch-status" id="deepAnalysisStatus">准备就绪</div>
                </div>
              <div class="batch-export-section">
                <div class="export-controls">
                  <button type="button" id="exportCurveDataBtn" class="batch-btn secondary" disabled>导出曲线数据</button>
                  <button type="button" id="batchChartsBtn" class="batch-btn secondary" disabled>批量图表</button>
                </div>
                <div class="curve-data-upload" id="curveDataUpload" style="display: none;">
                  <div class="drop-zone" id="curveDataDropZone">
                    <div class="drop-zone-content">
                      <p class="drop-zone-text">拖拽曲线数据文件到此处</p>
                      <p class="drop-zone-text">或</p>
                      <input type="file" id="curveDataFileInput" accept=".json,.csv" style="display: none;">
                      <button type="button" id="curveDataLoadBtn" class="batch-btn secondary">加载曲线数据</button>
                    </div>
                  </div>
                </div>
                <div class="batch-charts-container" id="batchChartsContainer" style="display: none;">
                  <div class="charts-header">
                    <h3>批量图表显示</h3>
                    <div class="chart-controls">
                      <div class="batch-curve-toggle">
                        <label><input type="checkbox" id="batchShowWhite" checked> 白曲线</label>
                        <label><input type="checkbox" id="batchShowBlue" checked> 蓝曲线</label>
                        <label><input type="checkbox" id="batchShowYellow" checked> 黄曲线</label>
                        <label><input type="checkbox" id="batchShowPink" checked> 粉曲线</label>
                        <label><input type="checkbox" id="batchShowPurple" checked> 紫曲线</label>
                        <label><input type="checkbox" id="batchShowOrange" checked> 橙曲线</label>
                      </div>
                      <button type="button" id="clearBatchChartsBtn" class="batch-btn secondary" style="font-size: 11px; padding: 4px 8px;">清除图表</button>
                    </div>
                  </div>
                  <div class="charts-grid" id="chartsGrid">
                    <!-- 图表将在这里动态生成 -->
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="section video-selector">
            <label class="label">视频选择</label>
            <select id="videoSelector" class="video-select" disabled>
              <option value="">请先分析视频</option>
            </select>
          </div>
          <div class="section info-panel">
            <label class="label">时间轴信息</label>
            <div class="info-panel-content">
              <div class="timestamp-display">
                <span class="info-label">时间:</span>
                <span id="infoTimestamp" class="info-value">--</span>
              </div>
              <div class="curve-values">
                <div class="curve-value">
                  <span class="curve-label blue">蓝:</span>
                  <span id="infoBlueValue" class="curve-number">--</span>
                </div>
                <div class="curve-value">
                  <span class="curve-label yellow">黄:</span>
                  <span id="infoYellowValue" class="curve-number">--</span>
                </div>
                <div class="curve-value">
                  <span class="curve-label white">白:</span>
                  <span id="infoWhiteValue" class="curve-number">--</span>
                </div>
                <div class="curve-value">
                  <span class="curve-label pink">粉:</span>
                  <span id="infoPinkValue" class="curve-number">--</span>
                </div>
                <div class="curve-value">
                  <span class="curve-label purple">紫:</span>
                  <span id="infoPurpleValue" class="curve-number">--</span>
                </div>
                <div class="curve-value">
                  <span class="curve-label orange">橙:</span>
                  <span id="infoOrangeValue" class="curve-number">--</span>
                </div>
              </div>
              <div class="info-status">
                <span id="infoStatus" class="status-text">点击时间轴查看曲线值</span>
              </div>
              <button id="clearInfoBtn" class="clear-btn">清除信息</button>
            </div>
          </div>
          <div class="section interval-panel">
            <label class="label">下一个着色区间</label>
            <div class="interval-content">
              <button id="findNextIntervalBtn" class="find-interval-btn">查找下一个区间</button>
              <div id="nextIntervalInfo" class="interval-info" style="display:none">
                <div class="interval-row">
                  <span class="interval-label">起始帧:</span>
                  <span id="intervalStartFrame" class="interval-number">--</span>
                </div>
                <div class="interval-row">
                  <span class="interval-label">结束帧:</span>
                  <span id="intervalEndFrame" class="interval-number">--</span>
                </div>
                <div class="interval-row">
                  <span class="interval-label">总帧数:</span>
                  <span id="intervalTotalFrames" class="interval-number">--</span>
                </div>
                <div class="frame-nav-container">
                  <button id="jumpToIntervalBtn" class="jump-btn">跳转到区间</button>
                  <button id="prevFrameBtn" class="frame-nav-btn prev-frame-btn">◀ 前一帧</button>
                </div>
                <div class="frame-nav-container">
                  <button id="nextFrameBtn" class="frame-nav-btn next-frame-btn">后一帧 ▶</button>
                  <button id="jumpToIntervalEndBtn" class="jump-btn jump-btn-end">跳转到结束</button>
                </div>

                <!-- 曲线统计信息 -->
                <div class="interval-statistics" id="intervalStatistics" style="display:none">
                  <div class="statistics-header">区间曲线统计</div>
                  <div class="statistics-grid">
                    <div class="curve-statistics">
                      <div class="curve-stats-header">
                        <span class="curve-stat-label blue">蓝曲线</span>
                      </div>
                      <div class="curve-stats-values">
                        <span class="stat-item">最小: <span id="blueStatMin" class="stat-number">--</span></span>
                        <span class="stat-item">最大: <span id="blueStatMax" class="stat-number">--</span></span>
                        <span class="stat-item">平均: <span id="blueStatAvg" class="stat-number">--</span></span>
                      </div>
                    </div>
                    <div class="curve-statistics">
                      <div class="curve-stats-header">
                        <span class="curve-stat-label yellow">黄曲线</span>
                      </div>
                      <div class="curve-stats-values">
                        <span class="stat-item">最小: <span id="yellowStatMin" class="stat-number">--</span></span>
                        <span class="stat-item">最大: <span id="yellowStatMax" class="stat-number">--</span></span>
                        <span class="stat-item">平均: <span id="yellowStatAvg" class="stat-number">--</span></span>
                      </div>
                    </div>
                    <div class="curve-statistics">
                      <div class="curve-stats-header">
                        <span class="curve-stat-label white">白曲线</span>
                      </div>
                      <div class="curve-stats-values">
                        <span class="stat-item">最小: <span id="whiteStatMin" class="stat-number">--</span></span>
                        <span class="stat-item">最大: <span id="whiteStatMax" class="stat-number">--</span></span>
                        <span class="stat-item">平均: <span id="whiteStatAvg" class="stat-number">--</span></span>
                      </div>
                    </div>
                    <div class="curve-statistics">
                      <div class="curve-stats-header">
                        <span class="curve-stat-label pink">粉曲线</span>
                      </div>
                      <div class="curve-stats-values">
                        <span class="stat-item">最小: <span id="pinkStatMin" class="stat-number">--</span></span>
                        <span class="stat-item">最大: <span id="pinkStatMax" class="stat-number">--</span></span>
                        <span class="stat-item">平均: <span id="pinkStatAvg" class="stat-number">--</span></span>
                      </div>
                    </div>
                    <div class="curve-statistics">
                      <div class="curve-stats-header">
                        <span class="curve-stat-label purple">紫曲线</span>
                      </div>
                      <div class="curve-stats-values">
                        <span class="stat-item">最小: <span id="purpleStatMin" class="stat-number">--</span></span>
                        <span class="stat-item">最大: <span id="purpleStatMax" class="stat-number">--</span></span>
                        <span class="stat-item">平均: <span id="purpleStatAvg" class="stat-number">--</span></span>
                      </div>
                    </div>
                    <div class="curve-statistics">
                      <div class="curve-stats-header">
                        <span class="curve-stat-label orange">橙曲线</span>
                      </div>
                      <div class="curve-stats-values">
                        <span class="stat-item">最小: <span id="orangeStatMin" class="stat-number">--</span></span>
                        <span class="stat-item">最大: <span id="orangeStatMax" class="stat-number">--</span></span>
                        <span class="stat-item">平均: <span id="orangeStatAvg" class="stat-number">--</span></span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              <div id="noIntervalInfo" class="no-interval" style="display:none">
                <span class="interval-status">暂无下一个着色区间</span>
              </div>
            </div>
          </div>
          <div class="section small" id="status"></div>
        </aside>

        <main class="main">
  <div class="content-grid">
    <div class="left-col">
      <div class="panel video-panel">
        <div class="panel-header">Video & ROI</div>
        <div class="panel-body video-box">
          <div class="roi-mode-selector">
            <label><input type="radio" name="roiMode" value="drag" checked> 拖拽模式</label>
            <label><input type="radio" name="roiMode" value="center"> 中心点模式</label>
          </div>
          <div class="roi-params" id="roiParams" style="display:none">
            <label>宽度: <input type="number" id="roiWidth" min="10" max="500" value="100"></label>
            <label>高度: <input type="number" id="roiHeight" min="10" max="500" value="200"></label>
          </div>
          <div id="videoWrap" class="video-wrap">
            <video id="video" controls></video>
            <canvas id="overlay"></canvas>
          </div>
          <div class="hint">Select ROI: left-drag; middle button pan; right toggles</div>
        </div>
      </div>
      <div class="panel">
        <div class="panel-header">Analysis</div>
        <div class="panel-body">
          <div id="resultText" class="result-text">Waiting for analysis...</div>
          <div class="badges" id="methodBadges"></div>
          <div class="stats" id="stats"></div>
          <div class="curve-toggle">
            <label><input type="checkbox" id="showBlue" checked> Blue Delta v</label>
            <label><input type="checkbox" id="showYellow" checked> Yellow d(Delta v)</label>
            <label><input type="checkbox" id="showWhiteRoi" checked> White ROI Avg</label>
            <label><input type="checkbox" id="showPinkStd" checked> Pink ROI Std</label>
            <label><input type="checkbox" id="showPurpleHigh" checked> Purple High Ratio</label>
            <label><input type="checkbox" id="showOrange" checked> Orange Conditional Ratio</label>
          </div>
          <div class="judge">
            <label style="display:flex;flex-direction:column;font-size:12px;color:#cbd5e1">
              Blue Max Threshold
              <input id="blue_max_thresh" type="number" step="0.1" value="35" style="margin-top:4px">
            </label>
            <div id="blueJudge" class="judge-indicator" title="Max of blue within shaded intervals">X</div>
          </div>
          <div class="judge">
            <label style="display:flex;flex-direction:column;font-size:12px;color:#cbd5e1">
              Purple Threshold
              <input id="p_high_threshold" type="number" min="0" max="255" step="1" value="130" style="margin-top:4px">
            </label>
            <div class="threshold-info" style="font-size:10px;color:#9ca3af;margin-top:2px">高灰度像素检测阈值 (0-255)</div>
          </div>
          <div class="judge">
            <label style="display:flex;flex-direction:column;font-size:12px;color:#cbd5e1">
              Orange Threshold 1
              <input id="conditional_threshold1" type="number" min="0" max="255" step="1" value="120" style="margin-top:4px">
            </label>
            <div class="threshold-info" style="font-size:10px;color:#9ca3af;margin-top:2px">平均像素值阈值 (0-255)</div>
          </div>
          <div class="judge">
            <label style="display:flex;flex-direction:column;font-size:12px;color:#cbd5e1">
              Orange Threshold 2
              <input id="conditional_threshold2" type="number" min="0" max="255" step="1" value="160" style="margin-top:4px">
            </label>
            <div class="threshold-info" style="font-size:10px;color:#9ca3af;margin-top:2px">条件像素值阈值 (0-255)</div>
          </div>
          <div class="chart-area">
            <canvas id="chart" height="200"></canvas>
            <canvas id="timeline" height="36" style="width:100%"></canvas>
          </div>
        </div>
      </div>
    </div>
    </div>
</main>
      </div>
    </div>
    <script src="script.js?v=hem11-functions-complete"></script>
  </body>
  </html>








