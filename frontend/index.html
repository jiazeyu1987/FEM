<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate, max-age=0" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>HEM Analyzer</title>
    <link rel="stylesheet" href="styles.css" />
  </head>
  <body>
    <div id="app">
      <header class="titlebar">
        <div class="title-left">
          <span class="dot red"></span>
          <span class="dot yellow"></span>
          <span class="dot green"></span>
        </div>
        <div class="title">HEM Analyzer</div>
        <div class="title-right">VS Code Theme</div>
      </header>

      <div class="container">
        <aside class="sidebar">
          <div class="section">
            <label class="label">单个视频文件 (mp4)</label>
            <input type="file" id="fileInput" accept="video/mp4" />
          </div>
          <div class="section">
            <label class="label">批量处理 - 选择文件夹</label>
            <input type="file" id="folderInput" webkitdirectory directory multiple style="display: none;" />
            <button id="selectFolderBtn" type="button">选择文件夹</button>
          </div>
          <div class="section" id="batchProgressSection" style="display: none;">
            <label class="label">批量分析进度</label>
            <button id="batchAnalyzeBtn">批量分析</button>
            <div class="batch-progress">
              <div class="progress-bar">
                <div class="progress-fill" style="width: 0%"></div>
              </div>
              <div class="progress-text">准备中...</div>
            </div>
            <div class="batch-file-list">
              <div class="batch-list-header">文件列表 (<span id="fileCount">0</span>)</div>
              <div class="batch-files" id="batchFiles"></div>
            </div>
          </div>
          <div class="section">
            <label class="label">采样帧率 (fps)</label>
            <input type="number" id="sampleFps" min="1" max="30" step="1" value="8" />
          </div>
          <div class="section">
            <label class="label">检测方案</label>
            <div class="checkboxes">
              <label><input type="checkbox" class="method" value="sudden" checked />突增</label>
              <label><input type="checkbox" class="method" value="threshold" checked />阈值</label>
              <label><input type="checkbox" class="method" value="relative" checked />相对</label>
            </div>
          </div>
          <div class="section">
            <label class="label">HEM 判定标准与参数</label>
            <div class="criteria">
              <details open>
                <summary>规则说明</summary>
                <ul>
                  <li>突增：ROI灰度一阶差分高于自适应门限（基于MAD）且超过最小Δ</li>
                  <li>阈值：ROI灰度高于“基线+偏移”并持续≥最小帧数</li>
                  <li>相对：ROI灰度与同帧参考均值的差值超过阈值</li>
                </ul>
              </details>
              <div class="grid">
                <label>平滑窗口 k<input id="p_smooth_k" type="number" min="1" max="21" step="1" value="3"></label>
                <label>基线样本 n<input id="p_baseline_n" type="number" min="3" max="200" step="1" value="10"></label>
                <label>突增倍数 k<input id="p_sudden_k" type="number" min="0" step="0.5" value="6"></label>
                <label>突增最小Δ<input id="p_sudden_min" type="number" min="0" step="0.5" value="4"></label>
                <label>阈值偏移 Δ<input id="p_threshold_delta" type="number" min="0" step="0.5" value="8"></label>
                <label>阈值最小帧<input id="p_threshold_hold" type="number" min="1" max="30" step="1" value="1"></label>
                <label>相对差阈值<input id="p_relative_delta" type="number" min="0" step="0.5" value="6"></label>
              </div>
            </div>
          </div>
          <div class="section">
            <button id="analyzeBtn" disabled>分析</button>
          </div>
          <div class="section">
            <label class="label">ROI设置</label>
            <div class="roi-controls">
              <label>
                选择ROI中心点
                <button id="selectROICenterBtn" type="button" style="width: 100%; margin-top: 5px;">点击选择中心点</button>
              </label>
              <div class="grid" style="margin-top: 10px;">
                <label>
                  ROI宽度 (px)
                  <input id="roi_width" type="number" min="30" max="100" step="1" value="80" />
                </label>
                <label>
                  ROI高度 (px)
                  <input id="roi_height" type="number" min="30" max="100" step="1" value="160" />
                </label>
              </div>
              <div class="roi-info" style="margin-top: 8px; font-size: 12px; color: var(--muted);">
                <span id="roi_center_info">未选择中心点</span>
              </div>
            </div>
          </div>
          <div class="section" id="thresholdInfoSection" style="display: none;">
            <label class="label">当前高亮度像素阈值</label>
            <div id="currentThresholdInfo" style="color: var(--text); font-weight: 600;">-</div>
            <div style="margin-top: 5px; font-size: 11px; color: var(--muted);">
              批量分析将测试 60-200 范围内的15个阈值
            </div>
          </div>
          <div class="section">
            <label class="label"><span id="shade_title">Timeline Shading</span></label>
            <div class="grid">
              <label><span id="rise_label">Rise Threshold (+)</span><input id="p_rise_thresh" type="number" step="0.1" value="15.5"></label>
              <label><span id="fall_label">Fall Threshold (-)</span><input id="p_fall_thresh" type="number" step="0.1" value="-3"></label>
            </div>
          </div>
          <div class="section small" id="status"></div>
          <div class="section" id="batchResultsSection" style="display: none;">
            <label class="label">批量分析结果</label>
            <div class="batch-summary">
              <div id="batchSummaryContent"></div>
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 10px;">
                <button id="exportBtn">导出为MD文件</button>
                <button id="exportCSVBtn">导出为CSV文件</button>
              </div>
            </div>
          </div>
              </aside>

        <main class="main">
  <div class="content-grid">
    <div class="left-col">
      <div class="panel video-panel">
        <div class="panel-header">Video & ROI</div>
        <div class="panel-body video-box">
          <div id="videoWrap" class="video-wrap">
            <video id="video" controls></video>
            <canvas id="overlay"></canvas>
          </div>
          <div class="hint">操作说明：中间按钮平移 | 右键切换ROI显示 | 点击"选择中心点"后在视频上点击选择ROI中心</div>
        </div>
      </div>
      <div class="panel">
        <div class="panel-header">Analysis</div>
        <div class="panel-body">
          <div id="resultText" class="result-text">Waiting for analysis...</div>
          <div class="badges" id="methodBadges"></div>
          <div class="stats" id="stats"></div>
          <div class="curve-toggle">
            <label><input type="checkbox" id="showBlue" checked> Blue Delta v</label>
            <label><input type="checkbox" id="showYellow" checked> Yellow Brightness %</label>
            <label><input type="checkbox" id="showWhite" checked> White ROI Mean</label>
          </div>
          <div class="judge">
            <label style="display:flex;flex-direction:column;font-size:12px;color:#cbd5e1">
              Blue Max Threshold
              <input id="blue_max_thresh" type="number" step="0.1" value="35" style="margin-top:4px">
            </label>
            <div id="blueJudge" class="judge-indicator" title="Max of blue within shaded intervals">X</div>
          </div>
          <div class="chart-area">
            <canvas id="chart" height="200"></canvas>
            <canvas id="timeline" height="36" style="width:100%"></canvas>
          </div>
        </div>
      </div>
    </div>
    <aside class="panel events-pane">
      <div class="panel-header">Events</div>
      <div class="panel-body">
        <div class="events-body">
          <table id="eventsTable">
            <thead>
              <tr><th>Time</th><th>Type</th><th>Score</th></tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </aside>
  </div>
</main>
      </div>
    </div>
    <script src="script.js?v=hem5"></script>
  </body>
  </html>








