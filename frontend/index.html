<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate, max-age=0" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>HEM Analyzer</title>
    <link rel="stylesheet" href="styles.css" />
  </head>
  <body>
    <div id="app">
      <header class="titlebar">
        <div class="title-left">
          <span class="dot red"></span>
          <span class="dot yellow"></span>
          <span class="dot green"></span>
        </div>
        <div class="title">HEM Analyzer</div>
        <div class="title-right">VS Code Theme</div>
      </header>

      <div class="container">
        <aside class="sidebar">
          <div class="section">
            <label class="label">视频文件 (mp4)</label>
            <input type="file" id="fileInput" accept="video/mp4" />
          </div>
          <div class="section">
            <label class="label">采样帧率 (fps)</label>
            <input type="number" id="sampleFps" min="1" max="30" step="1" value="8" />
          </div>
          <div class="section">
            <label class="label">检测方案</label>
            <div class="checkboxes">
              <label><input type="checkbox" class="method" value="sudden" checked />突增</label>
              <label><input type="checkbox" class="method" value="threshold" checked />阈值</label>
              <label><input type="checkbox" class="method" value="relative" checked />相对</label>
            </div>
          </div>
          <div class="section">
            <label class="label">HEM 判定标准与参数</label>
            <div class="criteria">
              <details open>
                <summary>规则说明</summary>
                <ul>
                  <li>突增：ROI灰度一阶差分高于自适应门限（基于MAD）且超过最小Δ</li>
                  <li>阈值：ROI灰度高于“基线+偏移”并持续≥最小帧数</li>
                  <li>相对：ROI灰度与同帧参考均值的差值超过阈值</li>
                </ul>
              </details>
              <div class="grid">
                <label>平滑窗口 k<input id="p_smooth_k" type="number" min="1" max="21" step="1" value="3"></label>
                <label>基线样本 n<input id="p_baseline_n" type="number" min="3" max="200" step="1" value="10"></label>
                <label>突增倍数 k<input id="p_sudden_k" type="number" min="0" step="0.5" value="6"></label>
                <label>突增最小Δ<input id="p_sudden_min" type="number" min="0" step="0.5" value="4"></label>
                <label>阈值偏移 Δ<input id="p_threshold_delta" type="number" min="0" step="0.5" value="8"></label>
                <label>阈值最小帧<input id="p_threshold_hold" type="number" min="1" max="30" step="1" value="1"></label>
                <label>相对差阈值<input id="p_relative_delta" type="number" min="0" step="0.5" value="6"></label>
              </div>
            </div>
          </div>
          <div class="section">
            <button id="analyzeBtn" disabled>分析</button>
          </div>
          <div class="section">
            <label class="label"><span id="shade_title">Timeline Shading</span></label>
            <div class="grid">
              <label><span id="rise_label">Rise Threshold (+)</span><input id="p_rise_thresh" type="number" step="0.1" value="15.5"></label>
              <label><span id="fall_label">Fall Threshold (-)</span><input id="p_fall_thresh" type="number" step="0.1" value="-3"></label>
            </div>
          </div>
          <div class="section batch-section">
            <label class="label">批量分析</label>
            <div class="batch-controls">
              <div class="batch-file-section">
                <div class="drop-zone" id="dropZone">
                  <div class="drop-zone-content">
                    <p class="drop-zone-text">拖拽视频文件到此处</p>
                    <p class="drop-zone-text">或</p>
                    <input type="file" id="batchFileInput" multiple accept="video/mp4" style="display: none;">
                    <button type="button" id="batchLoadBtn" class="batch-btn secondary">批量加载</button>
                  </div>
                </div>
                <div class="batch-file-list" id="batchFileList" style="display: none;">
                  <div class="file-list-header">
                    <span>已选择文件 (<span id="fileCount">0</span>)</span>
                    <button type="button" id="clearFilesBtn" class="clear-btn-small">清空</button>
                  </div>
                  <div class="file-list-items" id="fileListItems"></div>
                </div>
              </div>
              <div class="batch-action-section">
                <button type="button" id="batchAnalyzeBtn" class="batch-btn primary" disabled>批量分析</button>
                <div class="batch-progress" id="batchProgress" style="display: none;">
                  <div class="progress-header">
                    <span>批量分析进度</span>
                    <span id="progressText">0%</span>
                  </div>
                  <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                  </div>
                  <div class="batch-status" id="batchStatus">准备就绪</div>
                </div>
              </div>
            </div>
          </div>
          <div class="section video-selector">
            <label class="label">视频选择</label>
            <select id="videoSelector" class="video-select" disabled>
              <option value="">请先分析视频</option>
            </select>
          </div>
          <div class="section info-panel">
            <label class="label">时间轴信息</label>
            <div class="info-panel-content">
              <div class="timestamp-display">
                <span class="info-label">时间:</span>
                <span id="infoTimestamp" class="info-value">--</span>
              </div>
              <div class="curve-values">
                <div class="curve-value">
                  <span class="curve-label blue">蓝:</span>
                  <span id="infoBlueValue" class="curve-number">--</span>
                </div>
                <div class="curve-value">
                  <span class="curve-label yellow">黄:</span>
                  <span id="infoYellowValue" class="curve-number">--</span>
                </div>
                <div class="curve-value">
                  <span class="curve-label white">白:</span>
                  <span id="infoWhiteValue" class="curve-number">--</span>
                </div>
                <div class="curve-value">
                  <span class="curve-label pink">粉:</span>
                  <span id="infoPinkValue" class="curve-number">--</span>
                </div>
              </div>
              <div class="info-status">
                <span id="infoStatus" class="status-text">点击时间轴查看曲线值</span>
              </div>
              <button id="clearInfoBtn" class="clear-btn">清除信息</button>
            </div>
          </div>
          <div class="section small" id="status"></div>
        </aside>

        <main class="main">
  <div class="content-grid">
    <div class="left-col">
      <div class="panel video-panel">
        <div class="panel-header">Video & ROI</div>
        <div class="panel-body video-box">
          <div class="roi-mode-selector">
            <label><input type="radio" name="roiMode" value="drag" checked> 拖拽模式</label>
            <label><input type="radio" name="roiMode" value="center"> 中心点模式</label>
          </div>
          <div class="roi-params" id="roiParams" style="display:none">
            <label>宽度: <input type="number" id="roiWidth" min="10" max="500" value="100"></label>
            <label>高度: <input type="number" id="roiHeight" min="10" max="500" value="200"></label>
          </div>
          <div id="videoWrap" class="video-wrap">
            <video id="video" controls></video>
            <canvas id="overlay"></canvas>
          </div>
          <div class="hint">Select ROI: left-drag; middle button pan; right toggles</div>
        </div>
      </div>
      <div class="panel">
        <div class="panel-header">Analysis</div>
        <div class="panel-body">
          <div id="resultText" class="result-text">Waiting for analysis...</div>
          <div class="badges" id="methodBadges"></div>
          <div class="stats" id="stats"></div>
          <div class="curve-toggle">
            <label><input type="checkbox" id="showBlue" checked> Blue Delta v</label>
            <label><input type="checkbox" id="showYellow" checked> Yellow d(Delta v)</label>
            <label><input type="checkbox" id="showWhiteRoi" checked> White ROI Avg</label>
            <label><input type="checkbox" id="showPinkStd" checked> Pink ROI Std</label>
          </div>
          <div class="judge">
            <label style="display:flex;flex-direction:column;font-size:12px;color:#cbd5e1">
              Blue Max Threshold
              <input id="blue_max_thresh" type="number" step="0.1" value="35" style="margin-top:4px">
            </label>
            <div id="blueJudge" class="judge-indicator" title="Max of blue within shaded intervals">X</div>
          </div>
          <div class="chart-area">
            <canvas id="chart" height="200"></canvas>
            <canvas id="timeline" height="36" style="width:100%"></canvas>
          </div>
        </div>
      </div>
    </div>
    </div>
</main>
      </div>
    </div>
    <script src="script.js?v=hem11-functions-complete"></script>
  </body>
  </html>








